
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Use OpenCL in Android camera preview based CV application &#8212; OpenCV Documentation</title>
    <link rel="stylesheet" href="_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/doxyrest-pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/doxyrest-sphinxdoc.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    <script type="text/javascript" src="_static/target-highlight.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Using OpenCV Java with Eclipse" href="page_tutorial_java_eclipse.html" />
    <link rel="prev" title="Transition guide" href="page_tutorial_transition_guide.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="page_tutorial_java_eclipse.html" title="Using OpenCV Java with Eclipse"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="page_tutorial_transition_guide.html" title="Transition guide"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">OpenCV Documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="page_tutorial_root.html" >OpenCV Tutorials</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="page_tutorial_table_of_content_introduction.html" accesskey="U">Introduction to OpenCV</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h4>Previous topic</h4>
  <p class="topless"><a href="page_tutorial_transition_guide.html"
                        title="previous chapter">Transition guide</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="page_tutorial_java_eclipse.html"
                        title="next chapter">Using OpenCV Java with Eclipse</a></p>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="use-opencl-in-android-camera-preview-based-cv-application">
<span id="doxid-d7-dbd-tutorial-android-ocl-intro"></span><span id="index-0"></span><h1>Use OpenCL in Android camera preview based CV application</h1>
<p>This guide was designed to help you in use of <a class="reference external" href="https://www.khronos.org/opencl/">OpenCL</a> in Android camera preview based CV application. It was written for <a class="reference external" href="http://developer.android.com/tools/help/adt.html">Eclipse-based ADT tools</a> (deprecated by Google now), but it easily can be reproduced with <a class="reference external" href="http://developer.android.com/tools/studio/index.html">Android Studio</a>.</p>
<p>This tutorial assumes you have the following installed and configured:</p>
<ul class="simple">
<li>JDK</li>
<li>Android SDK and NDK</li>
<li>Eclipse IDE with ADT and CDT plugins</li>
</ul>
<p>It also assumes that you are familiar with Android Java and JNI programming basics. If you need help with anything of the above, you may refer to our <a class="reference internal" href="page_tutorial_android_dev_intro.html#doxid-d9-d3f-tutorial-android-dev-intro"><span class="std std-ref">Introduction into Android Development</span></a> guide.</p>
<p>This tutorial also assumes you have an Android operated device with OpenCL enabled.</p>
<p>The related source code is located within OpenCV samples at <a class="reference external" href="https://github.com/opencv/opencv/tree/master/samples/android/tutorial-4-opencl/">opencv/samples/android/tutorial-4-opencl</a> directory.</p>
<p class="rubric">Preface</p>
<p>Using <a class="reference external" href="https://en.wikipedia.org/wiki/General-purpose_computing_on_graphics_processing_units">GPGPU</a> via OpenCL for applications performance enhancements is quite a modern trend now. Some CV algo-s (e.g. image filtering) run much faster on a GPU than on a CPU. Recently it has become possible on Android OS.</p>
<p>The most popular CV application scenario for an Android operated device is starting camera in preview mode, applying some CV algo to every frame and displaying the preview frames modified by that CV algo.</p>
<p>Let’s consider how we can use OpenCL in this scenario. In particular let’s try two ways: direct calls to OpenCL API and recently introduced OpenCV T-API (aka <a class="reference external" href="https://docs.google.com/presentation/d/1qoa29N_B-s297-fp0-b3rBirvpzJQp8dCtllLQ4DVCY/present">Transparent API</a>) - implicit OpenCL accelerations of some OpenCV algo-s.</p>
<p class="rubric">Application structure</p>
<p>Starting Android API level 11 (Android 3.0) <a class="reference external" href="http://developer.android.com/reference/android/hardware/Camera.html">Camera API</a> allows use of OpenGL texture as a target for preview frames. Android API level 21 brings a new <a class="reference external" href="http://developer.android.com/reference/android/hardware/camera2/package-summary.html">Camera2 API</a> that provides much more control over the camera settings and usage modes, it allows several targets for preview frames and OpenGL texture in particular.</p>
<p>Having a preview frame in an OpenGL texture is a good deal for using OpenCL because there is an <a class="reference external" href="https://www.khronos.org/registry/cl/sdk/1.2/docs/man/xhtml/cl_khr_gl_sharing.html">OpenGL-OpenCL Interoperability API (cl_khr_gl_sharing)</a>, allowing sharing OpenGL texture data with OpenCL functions without copying (with some restrictions of course).</p>
<p>Let’s create a base for our application that just configures Android camera to send preview frames to OpenGL texture and displays these frames on display without any processing.</p>
<p>A minimal <code class="docutils literal notranslate"><span class="pre">Activity</span></code> class for that purposes looks like following:</p>
<pre class="highlight literal-block">
<span></span><span class="k">public</span> <span class="k">class</span> <span class="n">Tutorial4Activity</span> <span class="n">extends</span> <span class="n">Activity</span> <span class="p">{</span>

    <span class="k">private</span> <span class="n">MyGLSurfaceView</span> <span class="n">mView</span><span class="p">;</span>

    <span class="err">@</span><span class="n">Override</span>
    <span class="k">public</span> <span class="kt">void</span> <span class="n">onCreate</span><span class="p">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">super</span><span class="p">.</span><span class="n">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">);</span>
        <span class="n">requestWindowFeature</span><span class="p">(</span><span class="n">Window</span><span class="p">.</span><span class="n">FEATURE_NO_TITLE</span><span class="p">);</span>
        <span class="n">getWindow</span><span class="p">().</span><span class="n">setFlags</span><span class="p">(</span><span class="n">WindowManager</span><span class="p">.</span><span class="n">LayoutParams</span><span class="p">.</span><span class="n">FLAG_FULLSCREEN</span><span class="p">,</span>
                <span class="n">WindowManager</span><span class="p">.</span><span class="n">LayoutParams</span><span class="p">.</span><span class="n">FLAG_FULLSCREEN</span><span class="p">);</span>
        <span class="n">getWindow</span><span class="p">().</span><span class="n">setFlags</span><span class="p">(</span><span class="n">WindowManager</span><span class="p">.</span><span class="n">LayoutParams</span><span class="p">.</span><span class="n">FLAG_KEEP_SCREEN_ON</span><span class="p">,</span>
                <span class="n">WindowManager</span><span class="p">.</span><span class="n">LayoutParams</span><span class="p">.</span><span class="n">FLAG_KEEP_SCREEN_ON</span><span class="p">);</span>
        <span class="n">setRequestedOrientation</span><span class="p">(</span><span class="n">ActivityInfo</span><span class="p">.</span><span class="n">SCREEN_ORIENTATION_LANDSCAPE</span><span class="p">);</span>

        <span class="n">mView</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MyGLSurfaceView</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
        <span class="n">setContentView</span><span class="p">(</span><span class="n">mView</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="err">@</span><span class="n">Override</span>
    <span class="k">protected</span> <span class="kt">void</span> <span class="n">onPause</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">mView</span><span class="p">.</span><span class="n">onPause</span><span class="p">();</span>
        <span class="n">super</span><span class="p">.</span><span class="n">onPause</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="err">@</span><span class="n">Override</span>
    <span class="k">protected</span> <span class="kt">void</span> <span class="n">onResume</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">super</span><span class="p">.</span><span class="n">onResume</span><span class="p">();</span>
        <span class="n">mView</span><span class="p">.</span><span class="n">onResume</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre>
<p>And a minimal <code class="docutils literal notranslate"><span class="pre">View</span></code> class respectively:</p>
<pre class="highlight literal-block">
<span></span><span class="k">public</span> <span class="k">class</span> <span class="n">MyGLSurfaceView</span> <span class="n">extends</span> <span class="n">GLSurfaceView</span> <span class="p">{</span>

    <span class="n">MyGLRendererBase</span> <span class="n">mRenderer</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">MyGLSurfaceView</span><span class="p">(</span><span class="n">Context</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">super</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>

        <span class="k">if</span><span class="p">(</span><span class="n">android</span><span class="p">.</span><span class="n">os</span><span class="p">.</span><span class="n">Build</span><span class="p">.</span><span class="n">VERSION</span><span class="p">.</span><span class="n">SDK_INT</span> <span class="o">&gt;=</span> <span class="mi">21</span><span class="p">)</span>
            <span class="n">mRenderer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Camera2Renderer</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
        <span class="k">else</span>
            <span class="n">mRenderer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CameraRenderer</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>

        <span class="n">setEGLContextClientVersion</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
        <span class="n">setRenderer</span><span class="p">(</span><span class="n">mRenderer</span><span class="p">);</span>
        <span class="n">setRenderMode</span><span class="p">(</span><span class="n">GLSurfaceView</span><span class="p">.</span><span class="n">RENDERMODE_WHEN_DIRTY</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="err">@</span><span class="n">Override</span>
    <span class="k">public</span> <span class="kt">void</span> <span class="n">surfaceCreated</span><span class="p">(</span><span class="n">SurfaceHolder</span> <span class="n">holder</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">super</span><span class="p">.</span><span class="n">surfaceCreated</span><span class="p">(</span><span class="n">holder</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="err">@</span><span class="n">Override</span>
    <span class="k">public</span> <span class="kt">void</span> <span class="n">surfaceDestroyed</span><span class="p">(</span><span class="n">SurfaceHolder</span> <span class="n">holder</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">super</span><span class="p">.</span><span class="n">surfaceDestroyed</span><span class="p">(</span><span class="n">holder</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="err">@</span><span class="n">Override</span>
    <span class="k">public</span> <span class="kt">void</span> <span class="n">surfaceChanged</span><span class="p">(</span><span class="n">SurfaceHolder</span> <span class="n">holder</span><span class="p">,</span> <span class="kt">int</span> <a class="reference internal" href="group_core_utils.html#doxid-db-de0-group-core-utils-1ga0cccdb2f73859309b0611cf70b1b9409"><span class="std std-ref">format</span></a><span></span><span class="p">,</span> <span class="kt">int</span> <span class="n">w</span><span class="p">,</span> <span class="kt">int</span> <span class="n">h</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">super</span><span class="p">.</span><span class="n">surfaceChanged</span><span class="p">(</span><span class="n">holder</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="err">@</span><span class="n">Override</span>
    <span class="k">public</span> <span class="kt">void</span> <span class="n">onResume</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">super</span><span class="p">.</span><span class="n">onResume</span><span class="p">();</span>
        <span class="n">mRenderer</span><span class="p">.</span><span class="n">onResume</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="err">@</span><span class="n">Override</span>
    <span class="k">public</span> <span class="kt">void</span> <span class="n">onPause</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">mRenderer</span><span class="p">.</span><span class="n">onPause</span><span class="p">();</span>
        <span class="n">super</span><span class="p">.</span><span class="n">onPause</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre>
<p><strong>Note</strong> : we use two renderer classes: one for legacy <a class="reference external" href="http://developer.android.com/reference/android/hardware/Camera.html">Camera</a> API and another for modern <a class="reference external" href="http://developer.android.com/reference/android/hardware/camera2/package-summary.html">Camera2</a>.</p>
<p>A minimal <code class="docutils literal notranslate"><span class="pre">Renderer</span></code> class can be implemented in Java (OpenGL ES 2.0 <a class="reference external" href="http://developer.android.com/reference/android/opengl/GLES20.html">available</a> in Java), but since we are going to modify the preview texture with OpenCL let’s move OpenGL stuff to JNI. Here is a simple Java wrapper for our JNI stuff:</p>
<pre class="highlight literal-block">
<span></span><span class="k">public</span> <span class="k">class</span> <span class="n">NativeGLRenderer</span> <span class="p">{</span>
    <span class="k">static</span>
    <span class="p">{</span>
        <span class="n">System</span><span class="p">.</span><span class="n">loadLibrary</span><span class="p">(</span><span class="s">&quot;opencv_java3&quot;</span><span class="p">);</span> <span class="c1">// comment this when using OpenCV Manager</span>
        <span class="n">System</span><span class="p">.</span><span class="n">loadLibrary</span><span class="p">(</span><span class="s">&quot;JNIrender&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="n">native</span> <span class="kt">int</span> <span class="n">initGL</span><span class="p">();</span>
    <span class="k">public</span> <span class="k">static</span> <span class="n">native</span> <span class="kt">void</span> <span class="nf">closeGL</span><span class="p">();</span>
    <span class="k">public</span> <span class="k">static</span> <span class="n">native</span> <span class="kt">void</span> <span class="nf">drawFrame</span><span class="p">();</span>
    <span class="k">public</span> <span class="k">static</span> <span class="n">native</span> <span class="kt">void</span> <span class="nf">changeSize</span><span class="p">(</span><span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="kt">int</span> <span class="n">height</span><span class="p">);</span>
<span class="p">}</span>
</pre>
<p>Since <code class="docutils literal notranslate"><span class="pre">Camera</span></code> and <code class="docutils literal notranslate"><span class="pre">Camera2</span></code> APIs differ significantly in camera setup and control, let’s create a base class for the two corresponding renderers:</p>
<pre class="highlight literal-block">
<span></span><span class="k">public</span> <span class="n">abstract</span> <span class="k">class</span> <span class="n">MyGLRendererBase</span> <span class="n">implements</span> <span class="n">GLSurfaceView</span><span class="p">.</span><span class="n">Renderer</span><span class="p">,</span> <span class="n">SurfaceTexture</span><span class="p">.</span><span class="n">OnFrameAvailableListener</span> <span class="p">{</span>
    <span class="k">protected</span> <span class="k">final</span> <span class="n">String</span> <span class="n">LOGTAG</span> <span class="o">=</span> <span class="s">&quot;MyGLRendererBase&quot;</span><span class="p">;</span>

    <span class="k">protected</span> <span class="n">SurfaceTexture</span> <span class="n">mSTex</span><span class="p">;</span>
    <span class="k">protected</span> <span class="n">MyGLSurfaceView</span> <span class="n">mView</span><span class="p">;</span>

    <span class="k">protected</span> <span class="n">boolean</span> <span class="n">mGLInit</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="k">protected</span> <span class="n">boolean</span> <span class="n">mTexUpdate</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

    <span class="n">MyGLRendererBase</span><span class="p">(</span><span class="n">MyGLSurfaceView</span> <span class="n">view</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">mView</span> <span class="o">=</span> <span class="n">view</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="n">abstract</span> <span class="kt">void</span> <span class="n">openCamera</span><span class="p">();</span>
    <span class="k">protected</span> <span class="n">abstract</span> <span class="kt">void</span> <span class="nf">closeCamera</span><span class="p">();</span>
    <span class="k">protected</span> <span class="n">abstract</span> <span class="kt">void</span> <span class="nf">setCameraPreviewSize</span><span class="p">(</span><span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="kt">int</span> <span class="n">height</span><span class="p">);</span>

    <span class="k">public</span> <span class="kt">void</span> <span class="nf">onResume</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">Log</span><span class="p">.</span><span class="n">i</span><span class="p">(</span><span class="n">LOGTAG</span><span class="p">,</span> <span class="s">&quot;onResume&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="kt">void</span> <span class="nf">onPause</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">Log</span><span class="p">.</span><span class="n">i</span><span class="p">(</span><span class="n">LOGTAG</span><span class="p">,</span> <span class="s">&quot;onPause&quot;</span><span class="p">);</span>
        <span class="n">mGLInit</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
        <span class="n">mTexUpdate</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
        <span class="n">closeCamera</span><span class="p">();</span>
        <span class="k">if</span><span class="p">(</span><span class="n">mSTex</span> <span class="o">!=</span> <span class="n">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">mSTex</span><span class="p">.</span><span class="n">release</span><span class="p">();</span>
            <span class="n">mSTex</span> <span class="o">=</span> <span class="n">null</span><span class="p">;</span>
            <span class="n">NativeGLRenderer</span><span class="p">.</span><span class="n">closeGL</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="err">@</span><span class="n">Override</span>
    <span class="k">public</span> <span class="n">synchronized</span> <span class="kt">void</span> <span class="n">onFrameAvailable</span><span class="p">(</span><span class="n">SurfaceTexture</span> <span class="n">surfaceTexture</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//Log.i(LOGTAG, &quot;onFrameAvailable&quot;);</span>
        <span class="n">mTexUpdate</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="n">mView</span><span class="p">.</span><span class="n">requestRender</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="err">@</span><span class="n">Override</span>
    <span class="k">public</span> <span class="kt">void</span> <span class="n">onDrawFrame</span><span class="p">(</span><span class="n">GL10</span> <span class="n">gl</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//Log.i(LOGTAG, &quot;onDrawFrame&quot;);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mGLInit</span><span class="p">)</span>
            <span class="k">return</span><span class="p">;</span>

        <span class="n">synchronized</span> <span class="p">(</span><span class="k">this</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">mTexUpdate</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">mSTex</span><span class="p">.</span><span class="n">updateTexImage</span><span class="p">();</span>
                <span class="n">mTexUpdate</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">NativeGLRenderer</span><span class="p">.</span><span class="n">drawFrame</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="err">@</span><span class="n">Override</span>
    <span class="k">public</span> <span class="kt">void</span> <span class="n">onSurfaceChanged</span><span class="p">(</span><span class="n">GL10</span> <span class="n">gl</span><span class="p">,</span> <span class="kt">int</span> <span class="n">surfaceWidth</span><span class="p">,</span> <span class="kt">int</span> <span class="n">surfaceHeight</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Log</span><span class="p">.</span><span class="n">i</span><span class="p">(</span><span class="n">LOGTAG</span><span class="p">,</span> <span class="s">&quot;onSurfaceChanged(&quot;</span><span class="o">+</span><span class="n">surfaceWidth</span><span class="o">+</span><span class="s">&quot;x&quot;</span><span class="o">+</span><span class="n">surfaceHeight</span><span class="o">+</span><span class="s">&quot;)&quot;</span><span class="p">);</span>
        <span class="n">NativeGLRenderer</span><span class="p">.</span><span class="n">changeSize</span><span class="p">(</span><span class="n">surfaceWidth</span><span class="p">,</span> <span class="n">surfaceHeight</span><span class="p">);</span>
        <span class="n">setCameraPreviewSize</span><span class="p">(</span><span class="n">surfaceWidth</span><span class="p">,</span> <span class="n">surfaceHeight</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="err">@</span><span class="n">Override</span>
    <span class="k">public</span> <span class="kt">void</span> <span class="n">onSurfaceCreated</span><span class="p">(</span><span class="n">GL10</span> <span class="n">gl</span><span class="p">,</span> <span class="n">EGLConfig</span> <span class="n">config</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Log</span><span class="p">.</span><span class="n">i</span><span class="p">(</span><span class="n">LOGTAG</span><span class="p">,</span> <span class="s">&quot;onSurfaceCreated&quot;</span><span class="p">);</span>
        <span class="n">String</span> <span class="n">strGLVersion</span> <span class="o">=</span> <span class="n">GLES20</span><span class="p">.</span><span class="n">glGetString</span><span class="p">(</span><span class="n">GLES20</span><span class="p">.</span><span class="n">GL_VERSION</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">strGLVersion</span> <span class="o">!=</span> <span class="n">null</span><span class="p">)</span>
            <span class="n">Log</span><span class="p">.</span><span class="n">i</span><span class="p">(</span><span class="n">LOGTAG</span><span class="p">,</span> <span class="s">&quot;OpenGL ES version: &quot;</span> <span class="o">+</span> <span class="n">strGLVersion</span><span class="p">);</span>

        <span class="kt">int</span> <span class="n">hTex</span> <span class="o">=</span> <span class="n">NativeGLRenderer</span><span class="p">.</span><span class="n">initGL</span><span class="p">();</span>
        <span class="n">mSTex</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SurfaceTexture</span><span class="p">(</span><span class="n">hTex</span><span class="p">);</span>
        <span class="n">mSTex</span><span class="p">.</span><span class="n">setOnFrameAvailableListener</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
        <span class="n">openCamera</span><span class="p">();</span>
        <span class="n">mGLInit</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre>
<p>As you can see, inheritors for <code class="docutils literal notranslate"><span class="pre">Camera</span></code> and <code class="docutils literal notranslate"><span class="pre">Camera2</span></code> APIs should implement the following abstract methods:</p>
<pre class="highlight literal-block">
<span></span><span class="k">protected</span> <span class="n">abstract</span> <span class="kt">void</span> <span class="nf">openCamera</span><span class="p">();</span>
<span class="k">protected</span> <span class="n">abstract</span> <span class="kt">void</span> <span class="nf">closeCamera</span><span class="p">();</span>
<span class="k">protected</span> <span class="n">abstract</span> <span class="kt">void</span> <span class="nf">setCameraPreviewSize</span><span class="p">(</span><span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="kt">int</span> <span class="n">height</span><span class="p">);</span>
</pre>
<p>Let’s leave the details of their implementation beyond of this tutorial, please refer the <a class="reference external" href="https://github.com/opencv/opencv/tree/master/samples/android/tutorial-4-opencl/">source code</a> to see them.</p>
<p class="rubric">Preview Frames modification</p>
<p>The details OpenGL ES 2.0 initialization are also quite straightforward and noisy to be quoted here, but the important point here is that the OpeGL texture to be the target for camera preview should be of type <code class="docutils literal notranslate"><span class="pre">GL_TEXTURE_EXTERNAL_OES</span></code> (not <code class="docutils literal notranslate"><span class="pre">GL_TEXTURE_2D</span></code>), internally it keeps picture data in <em>YUV</em> format. That makes unable sharing it via CL-GL interop (<code class="docutils literal notranslate"><span class="pre">cl_khr_gl_sharing</span></code>) and accessing its pixel data via C/C++ code. To overcome this restriction we have to perform an OpenGL rendering from this texture to another regular <code class="docutils literal notranslate"><span class="pre">GL_TEXTURE_2D</span></code> one using <em>FrameBuffer Object</em> (aka FBO).</p>
<p class="rubric">C/C++ code</p>
<p>After that we can read (<em>copy</em>) pixel data from C/C++ via <code class="docutils literal notranslate"><span class="pre">glReadPixels()</span></code> and write them back to texture after modification via <code class="docutils literal notranslate"><span class="pre">glTexSubImage2D()</span></code>.</p>
<p class="rubric">Direct OpenCL calls</p>
<p>Also that <code class="docutils literal notranslate"><span class="pre">GL_TEXTURE_2D</span></code> texture can be shared with OpenCL without copying, but we have to create OpenCL context with special way for that:</p>
<pre class="highlight literal-block">
<span></span><span class="kt">void</span> <span class="nf">initCL</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">EGLDisplay</span> <span class="n">mEglDisplay</span> <span class="o">=</span> <span class="n">eglGetCurrentDisplay</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">mEglDisplay</span> <span class="o">==</span> <span class="n">EGL_NO_DISPLAY</span><span class="p">)</span>
        <span class="n">LOGE</span><span class="p">(</span><span class="s">&quot;initCL: eglGetCurrentDisplay() returned &#39;EGL_NO_DISPLAY&#39;, error = %x&quot;</span><span class="p">,</span> <span class="n">eglGetError</span><span class="p">());</span>

    <span class="n">EGLContext</span> <span class="n">mEglContext</span> <span class="o">=</span> <span class="n">eglGetCurrentContext</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">mEglContext</span> <span class="o">==</span> <span class="n">EGL_NO_CONTEXT</span><span class="p">)</span>
        <span class="n">LOGE</span><span class="p">(</span><span class="s">&quot;initCL: eglGetCurrentContext() returned &#39;EGL_NO_CONTEXT&#39;, error = %x&quot;</span><span class="p">,</span> <span class="n">eglGetError</span><span class="p">());</span>

    <span class="n">cl_context_properties</span> <span class="n">props</span><span class="p">[]</span> <span class="o">=</span>
    <span class="p">{</span>   <span class="n">CL_GL_CONTEXT_KHR</span><span class="p">,</span>   <span class="p">(</span><span class="n">cl_context_properties</span><span class="p">)</span> <span class="n">mEglContext</span><span class="p">,</span>
        <span class="n">CL_EGL_DISPLAY_KHR</span><span class="p">,</span>  <span class="p">(</span><span class="n">cl_context_properties</span><span class="p">)</span> <span class="n">mEglDisplay</span><span class="p">,</span>
        <span class="n">CL_CONTEXT_PLATFORM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
        <span class="mi">0</span> <span class="p">};</span>

    <span class="k">try</span>
    <span class="p">{</span>
        <span class="n">cl</span><span class="o">::</span><span class="n">Platform</span> <span class="n">p</span> <span class="o">=</span> <span class="n">cl</span><span class="o">::</span><span class="n">Platform</span><span class="o">::</span><span class="n">getDefault</span><span class="p">();</span>
        <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">getInfo</span><span class="o">&lt;</span><span class="n">CL_PLATFORM_EXTENSIONS</span><span class="o">&gt;</span><span class="p">();</span>
        <span class="k">if</span><span class="p">(</span><span class="n">ext</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;cl_khr_gl_sharing&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">::</span><span class="n">npos</span><span class="p">)</span>
            <span class="n">LOGE</span><span class="p">(</span><span class="s">&quot;Warning: CL-GL sharing isn&#39;t supported by PLATFORM&quot;</span><span class="p">);</span>
        <span class="n">props</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">cl_context_properties</span><span class="p">)</span> <span class="n">p</span><span class="p">();</span>

        <span class="n">theContext</span> <span class="o">=</span> <span class="n">cl</span><span class="o">::</span><span class="n">Context</span><span class="p">(</span><span class="n">CL_DEVICE_TYPE_GPU</span><span class="p">,</span> <span class="n">props</span><span class="p">);</span>
        <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">cl</span><span class="o">::</span><span class="n">Device</span><span class="o">&gt;</span> <span class="n">devs</span> <span class="o">=</span> <span class="n">theContext</span><span class="p">.</span><span class="n">getInfo</span><span class="o">&lt;</span><span class="n">CL_CONTEXT_DEVICES</span><span class="o">&gt;</span><span class="p">();</span>
        <span class="n">LOGD</span><span class="p">(</span><span class="s">&quot;Context returned %d devices, taking the 1st one&quot;</span><span class="p">,</span> <span class="n">devs</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
        <span class="n">ext</span> <span class="o">=</span> <span class="n">devs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">getInfo</span><span class="o">&lt;</span><span class="n">CL_DEVICE_EXTENSIONS</span><span class="o">&gt;</span><span class="p">();</span>
        <span class="k">if</span><span class="p">(</span><span class="n">ext</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;cl_khr_gl_sharing&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">::</span><span class="n">npos</span><span class="p">)</span>
            <span class="n">LOGE</span><span class="p">(</span><span class="s">&quot;Warning: CL-GL sharing isn&#39;t supported by DEVICE&quot;</span><span class="p">);</span>

        <span class="n">theQueue</span> <span class="o">=</span> <span class="n">cl</span><span class="o">::</span><span class="n">CommandQueue</span><span class="p">(</span><span class="n">theContext</span><span class="p">,</span> <span class="n">devs</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

        <span class="c1">// ...</span>
    <span class="p">}</span>
    <span class="k">catch</span><span class="p">(</span><span class="n">cl</span><span class="o">::</span><span class="n">Error</span><span class="o">&amp;</span> <span class="n">e</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">LOGE</span><span class="p">(</span><span class="s">&quot;cl::Error: %s (%d)&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">what</span><span class="p">(),</span> <span class="n">e</span><span class="p">.</span><span class="n">err</span><span class="p">());</span>
    <span class="p">}</span>
    <span class="k">catch</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">exception</span><span class="o">&amp;</span> <span class="n">e</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">LOGE</span><span class="p">(</span><span class="s">&quot;std::exception: %s&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">what</span><span class="p">());</span>
    <span class="p">}</span>
    <span class="k">catch</span><span class="p">(...)</span>
    <span class="p">{</span>
        <span class="n">LOGE</span><span class="p">(</span> <span class="s">&quot;OpenCL info: unknown error while initializing OpenCL stuff&quot;</span> <span class="p">);</span>
    <span class="p">}</span>
    <span class="n">LOGD</span><span class="p">(</span><span class="s">&quot;initCL completed&quot;</span><span class="p">);</span>
<span class="p">}</span>
</pre>
<p>To build this JNI code you need <strong>OpenCL 1.2</strong> headers from <a class="reference external" href="https://www.khronos.org/registry/cl/api/1.2/">Khronos web site</a> and the <strong>libOpenCL.so</strong> downloaded from the device you’ll run the application.</p>
<p>Then the texture can be wrapped by a <code class="docutils literal notranslate"><span class="pre">cl::ImageGL</span></code> object and processed via OpenCL calls:</p>
<pre class="highlight literal-block">
<span></span><span class="n">cl</span><span class="o">::</span><span class="n">ImageGL</span> <span class="n">imgIn</span> <span class="p">(</span><span class="n">theContext</span><span class="p">,</span> <span class="n">CL_MEM_READ_ONLY</span><span class="p">,</span>  <span class="n">GL_TEXTURE_2D</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">texIn</span><span class="p">);</span>
<span class="n">cl</span><span class="o">::</span><span class="n">ImageGL</span> <span class="n">imgOut</span><span class="p">(</span><span class="n">theContext</span><span class="p">,</span> <span class="n">CL_MEM_WRITE_ONLY</span><span class="p">,</span> <span class="n">GL_TEXTURE_2D</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">texOut</span><span class="p">);</span>

<span class="n">std</span><span class="o">::</span><span class="n">vector</span> <span class="o">&lt;</span> <span class="n">cl</span><span class="o">::</span><span class="n">Memory</span> <span class="o">&gt;</span> <span class="n">images</span><span class="p">;</span>
<span class="n">images</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">imgIn</span><span class="p">);</span>
<span class="n">images</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">imgOut</span><span class="p">);</span>
<span class="n">theQueue</span><span class="p">.</span><span class="n">enqueueAcquireGLObjects</span><span class="p">(</span><span class="o">&amp;</span><span class="n">images</span><span class="p">);</span>
<span class="n">theQueue</span><span class="p">.</span><span class="n">finish</span><span class="p">();</span>

<span class="n">cl</span><span class="o">::</span><span class="n">Kernel</span> <a class="reference internal" href="group_imgproc_filter.html#doxid-d4-d86-group-imgproc-filter-1gad78703e4c8fe703d479c1860d76429e6"><span class="std std-ref">Laplacian</span></a><span></span> <span class="o">=</span> <span class="p">...</span>
<span class="n">Laplacian</span><span class="p">.</span><span class="n">setArg</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">imgIn</span><span class="p">);</span>
<span class="n">Laplacian</span><span class="p">.</span><span class="n">setArg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">imgOut</span><span class="p">);</span>
<span class="n">theQueue</span><span class="p">.</span><span class="n">finish</span><span class="p">();</span>

<span class="n">theQueue</span><span class="p">.</span><span class="n">enqueueNDRangeKernel</span><span class="p">(</span><span class="n">Laplacian</span><span class="p">,</span> <span class="n">cl</span><span class="o">::</span><span class="n">NullRange</span><span class="p">,</span> <span class="n">cl</span><span class="o">::</span><span class="n">NDRange</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">),</span> <span class="n">cl</span><span class="o">::</span><span class="n">NullRange</span><span class="p">);</span>
<span class="n">theQueue</span><span class="p">.</span><span class="n">finish</span><span class="p">();</span>

<span class="n">theQueue</span><span class="p">.</span><span class="n">enqueueReleaseGLObjects</span><span class="p">(</span><span class="o">&amp;</span><span class="n">images</span><span class="p">);</span>
<span class="n">theQueue</span><span class="p">.</span><span class="n">finish</span><span class="p">();</span>
</pre>
<p class="rubric">OpenCV T-API</p>
<p>But instead of writing OpenCL code by yourselves you may want to use <strong>OpenCV T-API</strong> that calls OpenCL implicitly. All that you need is to pass the created OpenCL context to OpenCV (via <code class="docutils literal notranslate"><a class="reference internal" href="group_core_opencl.html#doxid-dc-d83-group-core-opencl-1gaf83af36be2097fd43e3eba5c8f3025b1"><span class="std std-ref"><span class="pre">cv::ocl::attachContext()</span></span></a></code>) and somehow wrap OpenGL texture with <code class="docutils literal notranslate"><a class="reference internal" href="class_cv_UMat.html#doxid-d8-d82-classcv-1-1-u-mat"><span class="std std-ref"><span class="pre">cv::UMat</span></span></a></code>. Unfortunately <code class="docutils literal notranslate"><span class="pre">UMat</span></code> keeps OpenCL <em>buffer</em> internally, that can’t be wrapped over either OpenGL <em>texture</em> or OpenCL <em>image</em> - so we have to copy image data here:</p>
<pre class="highlight literal-block">
<span></span><span class="n">cl</span><span class="o">::</span><span class="n">ImageGL</span> <span class="n">imgIn</span> <span class="p">(</span><span class="n">theContext</span><span class="p">,</span> <span class="n">CL_MEM_READ_ONLY</span><span class="p">,</span>  <span class="n">GL_TEXTURE_2D</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tex</span><span class="p">);</span>
<span class="n">std</span><span class="o">::</span><span class="n">vector</span> <span class="o">&lt;</span> <span class="n">cl</span><span class="o">::</span><span class="n">Memory</span> <span class="o">&gt;</span> <span class="n">images</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">imgIn</span><span class="p">);</span>
<span class="n">theQueue</span><span class="p">.</span><span class="n">enqueueAcquireGLObjects</span><span class="p">(</span><span class="o">&amp;</span><span class="n">images</span><span class="p">);</span>
<span class="n">theQueue</span><span class="p">.</span><span class="n">finish</span><span class="p">();</span>

<a class="reference internal" href="class_cv_UMat.html#doxid-d8-d82-classcv-1-1-u-mat"><span class="std std-ref">cv::UMat</span></a><span></span> <span class="n">uIn</span><span class="p">,</span> <span class="n">uOut</span><span class="p">,</span> <span class="n">uTmp</span><span class="p">;</span>
<a class="reference internal" href="group_core_opencl.html#doxid-dc-d83-group-core-opencl-1gada97cc08c31e416b957e23b480334b6c"><span class="std std-ref">cv::ocl::convertFromImage</span></a><span></span><span class="p">(</span><span class="n">imgIn</span><span class="p">(),</span> <span class="n">uIn</span><span class="p">);</span>
<span class="n">theQueue</span><span class="p">.</span><span class="n">enqueueReleaseGLObjects</span><span class="p">(</span><span class="o">&amp;</span><span class="n">images</span><span class="p">);</span>

<a class="reference internal" href="group_imgproc_filter.html#doxid-d4-d86-group-imgproc-filter-1gad78703e4c8fe703d479c1860d76429e6"><span class="std std-ref">cv::Laplacian</span></a><span></span><span class="p">(</span><span class="n">uIn</span><span class="p">,</span> <span class="n">uTmp</span><span class="p">,</span> <a class="reference internal" href="group_core_hal_interface.html#doxid-d1-d1b-group-core-hal-interface-1ga32b18d904ee2b1731a9416a8eef67d06"><span class="std std-ref">CV_8U</span></a><span></span><span class="p">);</span>
<a class="reference internal" href="namespace_cv.html#doxid-d2-d75-namespacecv"><span class="std std-ref">cv</span></a><span></span><span class="o">:</span><a class="reference internal" href="group_core_array.html#doxid-d2-de8-group-core-array-1ga979d898a58d7f61c53003e162e7ad89f"><span class="std std-ref">multiply</span></a><span></span><span class="p">(</span><span class="n">uTmp</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">uOut</span><span class="p">);</span>
<a class="reference internal" href="namespace_cv_ocl.html#doxid-dc-d83-group-core-opencl-1gabfca32247f267c662b3bff6587d14b40"><span class="std std-ref">cv::ocl::finish</span></a><span></span><span class="p">();</span>

<span class="n">cl</span><span class="o">::</span><span class="n">ImageGL</span> <span class="n">imgOut</span><span class="p">(</span><span class="n">theContext</span><span class="p">,</span> <span class="n">CL_MEM_WRITE_ONLY</span><span class="p">,</span> <span class="n">GL_TEXTURE_2D</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tex</span><span class="p">);</span>
<span class="n">images</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="n">images</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">imgOut</span><span class="p">);</span>
<span class="n">theQueue</span><span class="p">.</span><span class="n">enqueueAcquireGLObjects</span><span class="p">(</span><span class="o">&amp;</span><span class="n">images</span><span class="p">);</span>
<a class="reference internal" href="global.html#doxid-da-d06-autogenerated-2opencl-core-8hpp-1a476451dfc75ae3052f996800d79fed7a"><span class="std std-ref">cl_mem</span></a><span></span> <span class="n">clBuffer</span> <span class="o">=</span> <span class="p">(</span><a class="reference internal" href="global.html#doxid-da-d06-autogenerated-2opencl-core-8hpp-1a476451dfc75ae3052f996800d79fed7a"><span class="std std-ref">cl_mem</span></a><span></span><span class="p">)</span><span class="n">uOut</span><span class="p">.</span><a class="reference internal" href="class_cv_UMat.html#doxid-d8-d82-classcv-1-1-u-mat-1ad0a6c367bf2af33c1f8d34c51ba1f3da"><span class="std std-ref">handle</span></a><span></span><span class="p">(</span><a class="reference internal" href="namespace_cv.html#doxid-dc-d84-group-core-basic-1gga399140175919325d93e19dc058339ec8a39d5f615d02cac084ab1dd0cb4f7c221"><span class="std std-ref">cv::ACCESS_READ</span></a><span></span><span class="p">);</span>
<a class="reference internal" href="global.html#doxid-da-d06-autogenerated-2opencl-core-8hpp-1a7b4f57ee7bb74ac25798c3eb1c51560f"><span class="std std-ref">cl_command_queue</span></a><span></span> <span class="n">q</span> <span class="o">=</span> <span class="p">(</span><a class="reference internal" href="global.html#doxid-da-d06-autogenerated-2opencl-core-8hpp-1a7b4f57ee7bb74ac25798c3eb1c51560f"><span class="std std-ref">cl_command_queue</span></a><span></span><span class="p">)</span><a class="reference internal" href="class_cv_ocl_Queue.html#doxid-d2-de6-classcv-1-1ocl-1-1-queue-1a4f7a22c9c0f2b2c6ee6b47cc19519fef"><span class="std std-ref">cv::ocl::Queue::getDefault</span></a><span></span><span class="p">().</span><a class="reference internal" href="class_cv_ocl_Queue.html#doxid-d2-de6-classcv-1-1ocl-1-1-queue-1a8d201148fb55a19e748b20b2f50a0610"><span class="std std-ref">ptr</span></a><span></span><span class="p">();</span>
<span class="kt">size_t</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kt">size_t</span> <span class="n">origin</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>
<span class="kt">size_t</span> <span class="n">region</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="mi">1</span> <span class="p">};</span>
<a class="reference internal" href="group_core_utils.html#doxid-db-de0-group-core-utils-1gaf62bcd90f70e275191ab95136d85906b"><span class="std std-ref">CV_Assert</span></a><span></span><span class="p">(</span><a class="reference internal" href="global.html#doxid-da-d06-autogenerated-2opencl-core-8hpp-1ad75677001bd103f99f5b4ff052fcfa14"><span class="std std-ref">clEnqueueCopyBufferToImage</span></a><span></span> <span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">clBuffer</span><span class="p">,</span> <span class="n">imgOut</span><span class="p">(),</span> <span class="n">offset</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">region</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">==</span> <span class="n">CL_SUCCESS</span><span class="p">);</span>
<span class="n">theQueue</span><span class="p">.</span><span class="n">enqueueReleaseGLObjects</span><span class="p">(</span><span class="o">&amp;</span><span class="n">images</span><span class="p">);</span>
<a class="reference internal" href="namespace_cv_ocl.html#doxid-dc-d83-group-core-opencl-1gabfca32247f267c662b3bff6587d14b40"><span class="std std-ref">cv::ocl::finish</span></a><span></span><span class="p">();</span>
</pre>
<ul>
<li><p class="first">We have to make one more image data copy when placing back the modified image to the original OpenGL texture via OpenCL image wrapper.</p>
</li>
<li><p class="first">By default the OpenCL support (T-API) is disabled in OpenCV builds for Android OS (so it’s absent in official packages as of version 3.0), but it’s possible to rebuild locally OpenCV for Android with OpenCL/T-API enabled: use <code class="docutils literal notranslate"><span class="pre">-DWITH_OPENCL=YES</span></code> option for CMake.</p>
<pre class="highlight literal-block">
<span></span><span class="n">cd</span> <span class="n">opencv</span><span class="o">-</span><span class="n">build</span><span class="o">-</span><span class="n">android</span>
<span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">cmake</span><span class="p">.</span><span class="n">exe</span> <span class="o">-</span><span class="n">GNinja</span> <span class="o">-</span><span class="n">DCMAKE_MAKE_PROGRAM</span><span class="o">=</span><span class="s">&quot;path/to/ninja.exe&quot;</span> <span class="o">-</span><span class="n">DCMAKE_TOOLCHAIN_FILE</span><span class="o">=</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">opencv</span><span class="o">/</span><span class="n">platforms</span><span class="o">/</span><span class="n">android</span><span class="o">/</span><span class="n">android</span><span class="p">.</span><span class="n">toolchain</span><span class="p">.</span><span class="n">cmake</span> <span class="o">-</span><span class="n">DANDROID_ABI</span><span class="o">=</span><span class="s">&quot;armeabi-v7a with NEON&quot;</span> <span class="o">-</span><span class="n">DCMAKE_BUILD_WITH_INSTALL_RPATH</span><span class="o">=</span><span class="n">ON</span> <span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">opencv</span>
<span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">ninja</span><span class="p">.</span><span class="n">exe</span> <span class="n">install</span><span class="o">/</span><span class="n">strip</span>
</pre>
<p>To use your own modified <code class="docutils literal notranslate"><span class="pre">libopencv_java3.so</span></code> you have to keep inside your APK, not to use OpenCV Manager and load it manually via <code class="docutils literal notranslate"><span class="pre">System.loadLibrary(&quot;opencv_java3&quot;)</span></code>.</p>
<p class="rubric">Performance notes</p>
</li>
</ul>
<p>To compare the performance we measured FPS of the same preview frames modification (<em>Laplacian</em>) done by C/C++ code (call to <code class="docutils literal notranslate"><a class="reference internal" href="group_imgproc_filter.html#doxid-d4-d86-group-imgproc-filter-1gad78703e4c8fe703d479c1860d76429e6"><span class="std std-ref"><span class="pre">cv::Laplacian</span></span></a></code> with <code class="docutils literal notranslate"><a class="reference internal" href="class_cv_Mat.html#doxid-db-de6-classcv-1-1-mat"><span class="std std-ref"><span class="pre">cv::Mat</span></span></a></code>), by direct OpenCL calls (using OpenCL <em>images</em> for input and output), and by OpenCV <em>T-API</em> (call to <code class="docutils literal notranslate"><a class="reference internal" href="group_imgproc_filter.html#doxid-d4-d86-group-imgproc-filter-1gad78703e4c8fe703d479c1860d76429e6"><span class="std std-ref"><span class="pre">cv::Laplacian</span></span></a></code> with <code class="docutils literal notranslate"><a class="reference internal" href="class_cv_UMat.html#doxid-d8-d82-classcv-1-1-u-mat"><span class="std std-ref"><span class="pre">cv::UMat</span></span></a></code>) on <em>Sony Xperia Z3</em> with 720p camera resolution:</p>
<ul class="simple">
<li><strong>C/C++ version</strong> shows <strong>3-4 fps</strong></li>
<li><strong>direct OpenCL calls</strong> shows <strong>25-27 fps</strong></li>
<li><strong>OpenCV T-API</strong> shows <strong>11-13 fps</strong> (due to extra copying from <code class="docutils literal notranslate"><span class="pre">cl_image</span></code> to <code class="docutils literal notranslate"><span class="pre">cl_buffer</span></code> and back)</li>
</ul>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="page_tutorial_java_eclipse.html" title="Using OpenCV Java with Eclipse"
             >next</a> |</li>
        <li class="right" >
          <a href="page_tutorial_transition_guide.html" title="Transition guide"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">OpenCV Documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="page_tutorial_root.html" >OpenCV Tutorials</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="page_tutorial_table_of_content_introduction.html" >Introduction to OpenCV</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 1999-2017, OpenCV Maintainers.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.5.
    </div>
  </body>
</html>