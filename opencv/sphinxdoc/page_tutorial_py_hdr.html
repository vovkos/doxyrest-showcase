
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>High Dynamic Range (HDR) &#8212; OpenCV Documentation</title>
    <link rel="stylesheet" href="_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/doxyrest-pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/doxyrest-sphinxdoc.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    <script type="text/javascript" src="_static/target-highlight.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Image Denoising" href="page_tutorial_py_non_local_means.html" />
    <link rel="prev" title="Computational Photography" href="page_tutorial_py_table_of_contents_photo.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="page_tutorial_py_non_local_means.html" title="Image Denoising"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="page_tutorial_py_table_of_contents_photo.html" title="Computational Photography"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">OpenCV Documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="page_tutorial_py_root.html" >OpenCV-Python Tutorials</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="page_tutorial_py_table_of_contents_photo.html" accesskey="U">Computational Photography</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h4>Previous topic</h4>
  <p class="topless"><a href="page_tutorial_py_table_of_contents_photo.html"
                        title="previous chapter">Computational Photography</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="page_tutorial_py_non_local_means.html"
                        title="next chapter">Image Denoising</a></p>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="high-dynamic-range-hdr">
<span id="doxid-d2-df0-tutorial-py-hdr"></span><span id="index-0"></span><h1>High Dynamic Range (HDR)</h1>
<p class="rubric">Goal</p>
<p>In this chapter, we will</p>
<ul class="simple">
<li>Learn how to generate and display HDR image from an exposure sequence.</li>
<li>Use exposure fusion to merge an exposure sequence.</li>
</ul>
<p class="rubric">Theory</p>
<p>High-dynamic-range imaging (HDRI or HDR) is a technique used in imaging and photography to reproduce a greater dynamic range of luminosity than is possible with standard digital imaging or photographic techniques. While the human eye can adjust to a wide range of light conditions, most imaging devices use 8-bits per channel, so we are limited to only 256 levels. When we take photographs of a real world scene, bright regions may be overexposed, while the dark ones may be underexposed, so we can’t capture all details using a single exposure. HDR imaging works with images that use more than 8 bits per channel (usually 32-bit float values), allowing much wider dynamic range.</p>
<p>There are different ways to obtain HDR images, but the most common one is to use photographs of the scene taken with different exposure values. To combine these exposures it is useful to know your camera’s response function and there are algorithms to estimate it. After the HDR image has been merged, it has to be converted back to 8-bit to view it on usual displays. This process is called tonemapping. Additional complexities arise when objects of the scene or camera move between shots, since images with different exposures should be registered and aligned.</p>
<p>In this tutorial we show 2 algorithms (Debvec, Robertson) to generate and display HDR image from an exposure sequence, and demonstrate an alternative approach called exposure fusion (Mertens), that produces low dynamic range image and does not need the exposure times data. Furthermore, we estimate the camera response function (CRF) which is of great value for many computer vision algorithms. Each step of HDR pipeline can be implemented using different algorithms and parameters, so take a look at the reference manual to see them all.</p>
<p class="rubric">Exposure sequence HDR</p>
<p>In this tutorial we will look on the following scene, where we have 4 exposure images, with exposure times of: 15, 2.5, 1/4 and 1/30 seconds. (You can download the images from <a class="reference external" href="https://en.wikipedia.org/wiki/High-dynamic-range_imaging">Wikipedia</a>)</p>
<img alt="image" src="_images/exposures.jpg" />
<p class="rubric">1. Loading exposure images into a list</p>
<p>The first stage is simply loading all images into a list. In addition, we will need the exposure times for the regular HDR algorithms. Pay attention for the data types, as the images should be 1-channel or 3-channels 8-bit (np.uint8) and the exposure times need to be float32 and in seconds.</p>
<pre class="highlight literal-block">
<span></span><span class="n">import</span> <span class="n">cv2</span>
<span class="n">import</span> <span class="n">numpy</span> <span class="n">as</span> <span class="n">np</span>

<span class="cp"># Loading exposure images into a list</span>
<span class="n">img_fn</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;img0.jpg&quot;</span><span class="p">,</span> <span class="s">&quot;img1.jpg&quot;</span><span class="p">,</span> <span class="s">&quot;img2.jpg&quot;</span><span class="p">,</span> <span class="s">&quot;img3.jpg&quot;</span><span class="p">]</span>
<span class="n">img_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">cv2</span><span class="p">.</span><span class="n">imread</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span> <span class="k">for</span> <span class="n">fn</span> <span class="n">in</span> <span class="n">img_fn</span><span class="p">]</span>
<span class="n">exposure_times</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">([</span><span class="mf">15.0</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.0333</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">)</span>
</pre>
<p class="rubric">2. Merge exposures into HDR image</p>
<p>In this stage we merge the exposure sequence into one HDR image, showing 2 possibilities which we have in OpenCV. The first method is Debvec and the second one is Robertson. Notice that the HDR image is of type float32, and not uint8, as it contains the full dynamic range of all exposure images.</p>
<pre class="highlight literal-block">
<span></span><span class="cp"># Merge exposures to HDR image</span>
<span class="n">merge_debvec</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">createMergeDebevec</span><span class="p">()</span>
<span class="n">hdr_debvec</span> <span class="o">=</span> <span class="n">merge_debvec</span><span class="p">.</span><span class="n">process</span><span class="p">(</span><span class="n">img_list</span><span class="p">,</span> <span class="n">times</span><span class="o">=</span><span class="n">exposure_times</span><span class="p">.</span><span class="n">copy</span><span class="p">())</span>
<span class="n">merge_robertson</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">createMergeRobertson</span><span class="p">()</span>
<span class="n">hdr_robertson</span> <span class="o">=</span> <span class="n">merge_robertson</span><span class="p">.</span><span class="n">process</span><span class="p">(</span><span class="n">img_list</span><span class="p">,</span> <span class="n">times</span><span class="o">=</span><span class="n">exposure_times</span><span class="p">.</span><span class="n">copy</span><span class="p">())</span>
</pre>
<p class="rubric">3. Tonemap HDR image</p>
<p>We map the 32-bit float HDR data into the range [0..1]. Actually, in some cases the values can be larger than 1 or lower the 0, so notice we will later have to clip the data in order to avoid overflow.</p>
<pre class="highlight literal-block">
<span></span><span class="cp"># Tonemap HDR image</span>
<span class="n">tonemap1</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">createTonemapDurand</span><span class="p">(</span><span class="n">gamma</span><span class="o">=</span><span class="mf">2.2</span><span class="p">)</span>
<span class="n">res_debvec</span> <span class="o">=</span> <span class="n">tonemap1</span><span class="p">.</span><span class="n">process</span><span class="p">(</span><span class="n">hdr_debvec</span><span class="p">.</span><span class="n">copy</span><span class="p">())</span>
<span class="n">tonemap2</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">createTonemapDurand</span><span class="p">(</span><span class="n">gamma</span><span class="o">=</span><span class="mf">1.3</span><span class="p">)</span>
<span class="n">res_robertson</span> <span class="o">=</span> <span class="n">tonemap2</span><span class="p">.</span><span class="n">process</span><span class="p">(</span><span class="n">hdr_robertson</span><span class="p">.</span><span class="n">copy</span><span class="p">())</span>
</pre>
<p class="rubric">4. Merge exposures using Mertens fusion</p>
<p>Here we show an alternative algorithm to merge the exposure images, where we do not need the exposure times. We also do not need to use any tonemap algorithm because the Mertens algorithm already gives us the result in the range of [0..1].</p>
<pre class="highlight literal-block">
<span></span><span class="cp"># Exposure fusion using Mertens</span>
<span class="n">merge_mertens</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">createMergeMertens</span><span class="p">()</span>
<span class="n">res_mertens</span> <span class="o">=</span> <span class="n">merge_mertens</span><span class="p">.</span><span class="n">process</span><span class="p">(</span><span class="n">img_list</span><span class="p">)</span>
</pre>
<p class="rubric">5. Convert to 8-bit and save</p>
<p>In order to save or display the results, we need to convert the data into 8-bit integers in the range of [0..255].</p>
<pre class="highlight literal-block">
<span></span><span class="cp"># Convert datatype to 8-bit and save</span>
<span class="n">res_debvec_8bit</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">clip</span><span class="p">(</span><span class="n">res_debvec</span><span class="o">*</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">).</span><span class="n">astype</span><span class="p">(</span><span class="sc">&#39;uint8&#39;</span><span class="p">)</span>
<span class="n">res_robertson_8bit</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">clip</span><span class="p">(</span><span class="n">res_robertson</span><span class="o">*</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">).</span><span class="n">astype</span><span class="p">(</span><span class="sc">&#39;uint8&#39;</span><span class="p">)</span>
<span class="n">res_mertens_8bit</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">clip</span><span class="p">(</span><span class="n">res_mertens</span><span class="o">*</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">).</span><span class="n">astype</span><span class="p">(</span><span class="sc">&#39;uint8&#39;</span><span class="p">)</span>

<span class="n">cv2</span><span class="p">.</span><span class="n">imwrite</span><span class="p">(</span><span class="s">&quot;ldr_debvec.jpg&quot;</span><span class="p">,</span> <span class="n">res_debvec_8bit</span><span class="p">)</span>
<span class="n">cv2</span><span class="p">.</span><span class="n">imwrite</span><span class="p">(</span><span class="s">&quot;ldr_robertson.jpg&quot;</span><span class="p">,</span> <span class="n">res_robertson_8bit</span><span class="p">)</span>
<span class="n">cv2</span><span class="p">.</span><span class="n">imwrite</span><span class="p">(</span><span class="s">&quot;fusion_mertens.jpg&quot;</span><span class="p">,</span> <span class="n">res_mertens_8bit</span><span class="p">)</span>
</pre>
<p class="rubric">Results</p>
<p>You can see the different results but consider that each algorithm have additional extra parameters that you should fit to get your desired outcome. Best practice is to try the different methods and see which one performs best for your scene.</p>
<p class="rubric">Debvec:</p>
<img alt="image" src="_images/ldr_debvec.jpg" />
<p class="rubric">Robertson:</p>
<img alt="image" src="_images/ldr_robertson.jpg" />
<p class="rubric">Mertenes Fusion:</p>
<img alt="image" src="_images/fusion_mertens.jpg" />
<p class="rubric">Estimating Camera Response Function</p>
<p>The camera response function (CRF) gives us the connection between the scene radiance to the measured intensity values. The CRF if of great importance in some computer vision algorithms, including HDR algorithms. Here we estimate the inverse camera response function and use it for the HDR merge.</p>
<pre class="highlight literal-block">
<span></span><span class="cp"># Estimate camera response function (CRF)</span>
<span class="n">cal_debvec</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">createCalibrateDebevec</span><span class="p">()</span>
<span class="n">crf_debvec</span> <span class="o">=</span> <span class="n">cal_debvec</span><span class="p">.</span><span class="n">process</span><span class="p">(</span><span class="n">img_list</span><span class="p">,</span> <span class="n">times</span><span class="o">=</span><span class="n">exposure_times</span><span class="p">)</span>
<span class="n">hdr_debvec</span> <span class="o">=</span> <span class="n">merge_debvec</span><span class="p">.</span><span class="n">process</span><span class="p">(</span><span class="n">img_list</span><span class="p">,</span> <span class="n">times</span><span class="o">=</span><span class="n">exposure_times</span><span class="p">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">response</span><span class="o">=</span><span class="n">crf_debvec</span><span class="p">.</span><span class="n">copy</span><span class="p">())</span>
<span class="n">cal_robertson</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">createCalibrateRobertson</span><span class="p">()</span>
<span class="n">crf_robertson</span> <span class="o">=</span> <span class="n">cal_robertson</span><span class="p">.</span><span class="n">process</span><span class="p">(</span><span class="n">img_list</span><span class="p">,</span> <span class="n">times</span><span class="o">=</span><span class="n">exposure_times</span><span class="p">)</span>
<span class="n">hdr_robertson</span> <span class="o">=</span> <span class="n">merge_robertson</span><span class="p">.</span><span class="n">process</span><span class="p">(</span><span class="n">img_list</span><span class="p">,</span> <span class="n">times</span><span class="o">=</span><span class="n">exposure_times</span><span class="p">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">response</span><span class="o">=</span><span class="n">crf_robertson</span><span class="p">.</span><span class="n">copy</span><span class="p">())</span>
</pre>
<p>The camera response function is represented by a 256-length vector for each color channel. For this sequence we got the following estimation:</p>
<img alt="image" src="_images/crf.jpg" />
<p class="rubric">Additional Resources</p>
<ol class="arabic simple">
<li>Paul E Debevec and Jitendra Malik. Recovering high dynamic range radiance maps from photographs. In ACM SIGGRAPH 2008 classes, page 31. ACM, 2008.</li>
<li>Mark A Robertson, Sean Borman, and Robert L Stevenson. Dynamic range improvement through multiple exposures. In Image Processing, 1999. ICIP 99. Proceedings. 1999 International Conference on, volume 3, pages 159–163. IEEE, 1999.</li>
<li>Tom Mertens, Jan Kautz, and Frank Van Reeth. Exposure fusion. In Computer Graphics and Applications, 2007. PG‘07. 15th Pacific Conference on, pages 382–390. IEEE, 2007.</li>
<li>Images from <a class="reference external" href="https://en.wikipedia.org/wiki/High-dynamic-range_imaging">Wikipedia-HDR</a></li>
</ol>
<p class="rubric">Exercises</p>
<ol class="arabic simple">
<li>Try all tonemap algorithms: <a class="reference external" href="http://docs.opencv.org/master/da/d53/classcv_1_1TonemapDrago.html">Drago</a>, <a class="reference external" href="http://docs.opencv.org/master/da/d3d/classcv_1_1TonemapDurand.html">Durand</a>, <a class="reference external" href="http://docs.opencv.org/master/de/d76/classcv_1_1TonemapMantiuk.html">Mantiuk</a> and <a class="reference external" href="http://docs.opencv.org/master/d0/dec/classcv_1_1TonemapReinhard.html">Reinhard</a>.</li>
<li>Try changing the parameters in the HDR calibration and tonemap methods.</li>
</ol>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="page_tutorial_py_non_local_means.html" title="Image Denoising"
             >next</a> |</li>
        <li class="right" >
          <a href="page_tutorial_py_table_of_contents_photo.html" title="Computational Photography"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">OpenCV Documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="page_tutorial_py_root.html" >OpenCV-Python Tutorials</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="page_tutorial_py_table_of_contents_photo.html" >Computational Photography</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 1999-2017, OpenCV Maintainers.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.5.
    </div>
  </body>
</html>